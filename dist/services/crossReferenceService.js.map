{"version":3,"file":"crossReferenceService.js","sourceRoot":"","sources":["../../server/services/crossReferenceService.ts"],"names":[],"mappings":"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","sourcesContent":["import { storage } from '../storage';\r\n\r\ninterface DeviceMapping {\r\n  primaryId: string;\r\n  relatedIds: string[];\r\n  mappingType: 'manufacturer' | 'device_name' | 'regulation' | 'clinical_study';\r\n  confidence: number; // 0-1\r\n  lastUpdated: Date;\r\n}\r\n\r\ninterface RegulatoryTimeline {\r\n  deviceId: string;\r\n  timeline: TimelineEvent[];\r\n  jurisdiction: string;\r\n  currentStatus: string;\r\n}\r\n\r\ninterface TimelineEvent {\r\n  date: Date;\r\n  event: string;\r\n  authority: string;\r\n  status: string;\r\n  documents: string[];\r\n  impact: 'low' | 'medium' | 'high';\r\n}\r\n\r\ninterface StandardMapping {\r\n  standardId: string;\r\n  applicableRegulations: string[];\r\n  deviceCategories: string[];\r\n  requirements: string[];\r\n  lastUpdated: Date;\r\n}\r\n\r\nexport class CrossReferenceService {\r\n  private mappingThreshold = 0.75; // Minimum confidence for auto-mapping\r\n  \r\n  private async calculateSimilarity(str1: string, str2: string): Promise<number> {\r\n    const normalize = (s: string) => s.toLowerCase()\r\n      .replace(/[^\\w\\s]/g, '')\r\n      .replace(/\\s+/g, ' ')\r\n      .trim();\r\n    \r\n    const s1 = normalize(str1);\r\n    const s2 = normalize(str2);\r\n    \r\n    if (s1 === s2) return 1.0;\r\n    \r\n    // Jaccard similarity for text comparison\r\n    const words1 = new Set(s1.split(' '));\r\n    const words2 = new Set(s2.split(' '));\r\n    \r\n    const intersection = new Set([...words1].filter(x => words2.has(x)));\r\n    const union = new Set([...words1, ...words2]);\r\n    \r\n    return intersection.size / union.size;\r\n  }\r\n\r\n  private extractManufacturerFromContent(content: string): string | null {\r\n    // Extract manufacturer from various content formats\r\n    const patterns = [\r\n      /manufacturer[:\\s]+([^,\\n.]+)/i,\r\n      /applicant[:\\s]+([^,\\n.]+)/i,\r\n      /company[:\\s]+([^,\\n.]+)/i,\r\n      /sponsor[:\\s]+([^,\\n.]+)/i\r\n    ];\r\n    \r\n    for (const pattern of patterns) {\r\n      const match = content.match(pattern);\r\n      if (match && match[1]) {\r\n        return match[1].trim();\r\n      }\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  private extractDeviceNameFromTitle(title: string): string | null {\r\n    // Extract device name from title, removing regulatory prefixes\r\n    const cleanTitle = title\r\n      .replace(/^(FDA|EMA|BfArM|MHRA|Swissmedic)[\\s:]+/i, '')\r\n      .replace(/^(510\\(k\\)|PMA|CE Mark)[\\s:]+/i, '')\r\n      .replace(/^(Clearance|Approval|Registration)[\\s:]+/i, '');\r\n    \r\n    return cleanTitle.trim() || null;\r\n  }\r\n\r\n  async mapDevicesBetweenJurisdictions(): Promise<DeviceMapping[]> {\r\n    try {\r\n      console.log('[CrossRef] Starting device mapping between jurisdictions');\r\n      \r\n      const allUpdates = await storage.getAllRegulatoryUpdates();\r\n      const deviceMappings: DeviceMapping[] = [];\r\n      const processed = new Set<string>();\r\n      \r\n      // Group updates by potential device categories\r\n      const deviceGroups: Record<string, any[]> = {};\r\n      \r\n      for (const update of allUpdates) {\r\n        if (processed.has(update.id)) continue;\r\n        \r\n        const deviceName = this.extractDeviceNameFromTitle(update.title);\r\n        const manufacturer = this.extractManufacturerFromContent(update.content);\r\n        \r\n        if (!deviceName && !manufacturer) continue;\r\n        \r\n        const groupKey = `${manufacturer || 'unknown'}_${deviceName || 'unknown'}`;\r\n        \r\n        if (!deviceGroups[groupKey]) {\r\n          deviceGroups[groupKey] = [];\r\n        }\r\n        deviceGroups[groupKey].push(update);\r\n      }\r\n      \r\n      // Create mappings for devices found in multiple jurisdictions\r\n      for (const [groupKey, updates] of Object.entries(deviceGroups)) {\r\n        if (updates.length < 2) continue;\r\n        \r\n        const authorities = new Set(updates.map(u => u.authority));\r\n        if (authorities.size < 2) continue; // Must be cross-jurisdictional\r\n        \r\n        // Calculate confidence based on similarity\r\n        let totalConfidence = 0;\r\n        let comparisons = 0;\r\n        \r\n        for (let i = 0; i < updates.length; i++) {\r\n          for (let j = i + 1; j < updates.length; j++) {\r\n            const similarity = await this.calculateSimilarity(\r\n              updates[i].title + ' ' + updates[i].content,\r\n              updates[j].title + ' ' + updates[j].content\r\n            );\r\n            totalConfidence += similarity;\r\n            comparisons++;\r\n          }\r\n        }\r\n        \r\n        const averageConfidence = comparisons > 0 ? totalConfidence / comparisons : 0;\r\n        \r\n        if (averageConfidence >= this.mappingThreshold) {\r\n          const mapping: DeviceMapping = {\r\n            primaryId: updates[0].id,\r\n            relatedIds: updates.slice(1).map(u => u.id),\r\n            mappingType: 'manufacturer',\r\n            confidence: averageConfidence,\r\n            lastUpdated: new Date()\r\n          };\r\n          \r\n          deviceMappings.push(mapping);\r\n          updates.forEach(u => processed.add(u.id));\r\n        }\r\n      }\r\n      \r\n      console.log(`[CrossRef] Created ${deviceMappings.length} device mappings`);\r\n      return deviceMappings;\r\n    } catch (error) {\r\n      console.error('[CrossRef] Error mapping devices:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async generateRegulatoryTimeline(deviceId: string): Promise<RegulatoryTimeline | null> {\r\n    try {\r\n      console.log(`[CrossRef] Generating regulatory timeline for device: ${deviceId}`);\r\n      \r\n      const allUpdates = await storage.getAllRegulatoryUpdates();\r\n      const deviceUpdate = allUpdates.find(u => u.id === deviceId);\r\n      \r\n      if (!deviceUpdate) {\r\n        console.log(`[CrossRef] Device not found: ${deviceId}`);\r\n        return null;\r\n      }\r\n      \r\n      // Find related updates for the same device/manufacturer\r\n      const deviceName = this.extractDeviceNameFromTitle(deviceUpdate.title);\r\n      const manufacturer = this.extractManufacturerFromContent(deviceUpdate.content);\r\n      \r\n      const relatedUpdates = [];\r\n      \r\n      for (const update of allUpdates) {\r\n        if (update.id === deviceId) {\r\n          relatedUpdates.push(update);\r\n          continue;\r\n        }\r\n        \r\n        const updateDeviceName = this.extractDeviceNameFromTitle(update.title);\r\n        const updateManufacturer = this.extractManufacturerFromContent(update.content);\r\n        \r\n        // Match by device name or manufacturer\r\n        const deviceMatch = deviceName && updateDeviceName ? \r\n          await this.calculateSimilarity(deviceName, updateDeviceName) : 0;\r\n        const manufacturerMatch = manufacturer && updateManufacturer ? \r\n          await this.calculateSimilarity(manufacturer, updateManufacturer) : 0;\r\n        \r\n        if ((deviceMatch && deviceMatch > 0.7) || (manufacturerMatch && manufacturerMatch > 0.8)) {\r\n          relatedUpdates.push(update);\r\n        }\r\n      }\r\n      \r\n      // Convert to timeline events\r\n      const timelineEvents: TimelineEvent[] = relatedUpdates.map(update => ({\r\n        date: new Date(update.published_at),\r\n        event: this.categorizeEvent(update.type),\r\n        authority: update.authority,\r\n        status: update.status || 'Unknown',\r\n        documents: [update.id],\r\n        impact: update.priority === 'critical' ? 'high' : \r\n                update.priority === 'high' ? 'medium' : 'low'\r\n      }));\r\n      \r\n      // Sort by date\r\n      timelineEvents.sort((a, b) => a.date.getTime() - b.date.getTime());\r\n      \r\n      const timeline: RegulatoryTimeline = {\r\n        deviceId,\r\n        timeline: timelineEvents,\r\n        jurisdiction: deviceUpdate.region,\r\n        currentStatus: this.determineCurrentStatus(timelineEvents)\r\n      };\r\n      \r\n      console.log(`[CrossRef] Generated timeline with ${timelineEvents.length} events`);\r\n      return timeline;\r\n    } catch (error) {\r\n      console.error('[CrossRef] Error generating timeline:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private categorizeEvent(type: string): string {\r\n    const eventMap: Record<string, string> = {\r\n      'FDA 510(k) Clearance': 'Pre-market Clearance',\r\n      'FDA PMA Approval': 'Pre-market Approval',\r\n      'FDA Device Recall': 'Safety Action',\r\n      'CE Mark': 'European Conformity',\r\n      'EU MDR Device Registration': 'Registration',\r\n      'EU MDR Incident Report': 'Safety Report',\r\n      'Clinical Study': 'Clinical Evidence',\r\n      'RSS Update': 'Information Update'\r\n    };\r\n    \r\n    return eventMap[type] || 'Regulatory Update';\r\n  }\r\n\r\n  private determineCurrentStatus(events: TimelineEvent[]): string {\r\n    if (events.length === 0) return 'Unknown';\r\n    \r\n    const latestEvent = events[events.length - 1];\r\n    \r\n    if (latestEvent.event.includes('Recall') || latestEvent.event.includes('Safety')) {\r\n      return 'Under Safety Review';\r\n    }\r\n    \r\n    if (latestEvent.event.includes('Approval') || latestEvent.event.includes('Clearance')) {\r\n      return 'Approved';\r\n    }\r\n    \r\n    if (latestEvent.event.includes('Registration')) {\r\n      return 'Registered';\r\n    }\r\n    \r\n    return 'Active';\r\n  }\r\n\r\n  async mapStandardsToRegulations(): Promise<StandardMapping[]> {\r\n    try {\r\n      console.log('[CrossRef] Mapping standards to regulations');\r\n      \r\n      const allUpdates = await storage.getAllRegulatoryUpdates();\r\n      const standardMappings: StandardMapping[] = [];\r\n      \r\n      // Common medical device standards and their regulatory contexts\r\n      const knownStandards = [\r\n        {\r\n          id: 'ISO 13485:2016',\r\n          name: 'Quality Management Systems',\r\n          keywords: ['quality management', 'qms', 'iso 13485'],\r\n          regulations: ['EU MDR', 'FDA QSR', '21 CFR 820'],\r\n          categories: ['All Medical Devices']\r\n        },\r\n        {\r\n          id: 'ISO 10993',\r\n          name: 'Biological Evaluation',\r\n          keywords: ['biocompatibility', 'biological evaluation', 'iso 10993'],\r\n          regulations: ['EU MDR Annex I', 'FDA Biocompatibility'],\r\n          categories: ['Implantable Devices', 'Contact Devices']\r\n        },\r\n        {\r\n          id: 'ISO 14971:2019',\r\n          name: 'Risk Management',\r\n          keywords: ['risk management', 'risk analysis', 'iso 14971'],\r\n          regulations: ['EU MDR Article 10', 'FDA Risk Management'],\r\n          categories: ['All Medical Devices']\r\n        },\r\n        {\r\n          id: 'IEC 62304',\r\n          name: 'Medical Device Software',\r\n          keywords: ['software', 'medical device software', 'iec 62304'],\r\n          regulations: ['EU MDR Annex I', 'FDA Software Guidance'],\r\n          categories: ['Software as Medical Device', 'Device with Software']\r\n        }\r\n      ];\r\n      \r\n      for (const standard of knownStandards) {\r\n        const applicableUpdates = allUpdates.filter(update => {\r\n          const content = (update.title + ' ' + update.content).toLowerCase();\r\n          return standard.keywords.some(keyword => content.includes(keyword));\r\n        });\r\n        \r\n        const applicableRegulations = [...new Set(\r\n          applicableUpdates.map(update => `${update.authority} - ${update.type}`)\r\n        )];\r\n        \r\n        if (applicableUpdates.length > 0) {\r\n          const mapping: StandardMapping = {\r\n            standardId: standard.id,\r\n            applicableRegulations,\r\n            deviceCategories: standard.categories,\r\n            requirements: standard.regulations,\r\n            lastUpdated: new Date()\r\n          };\r\n          \r\n          standardMappings.push(mapping);\r\n        }\r\n      }\r\n      \r\n      console.log(`[CrossRef] Created ${standardMappings.length} standard mappings`);\r\n      return standardMappings;\r\n    } catch (error) {\r\n      console.error('[CrossRef] Error mapping standards:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async linkClinicalStudiesToApprovals(): Promise<DeviceMapping[]> {\r\n    try {\r\n      console.log('[CrossRef] Linking clinical studies to approvals');\r\n      \r\n      const allUpdates = await storage.getAllRegulatoryUpdates();\r\n      const clinicalMappings: DeviceMapping[] = [];\r\n      \r\n      // Find clinical studies\r\n      const clinicalStudies = allUpdates.filter(update => \r\n        update.type?.toLowerCase().includes('clinical') ||\r\n        update.content.toLowerCase().includes('clinical study') ||\r\n        update.content.toLowerCase().includes('clinical trial')\r\n      );\r\n      \r\n      // Find approvals/clearances\r\n      const approvals = allUpdates.filter(update =>\r\n        update.type?.includes('510(k)') ||\r\n        update.type?.includes('PMA') ||\r\n        update.type?.includes('CE Mark') ||\r\n        update.type?.includes('Approval') ||\r\n        update.type?.includes('Clearance')\r\n      );\r\n      \r\n      for (const study of clinicalStudies) {\r\n        const studyDeviceName = this.extractDeviceNameFromTitle(study.title);\r\n        const studyManufacturer = this.extractManufacturerFromContent(study.content);\r\n        \r\n        if (!studyDeviceName && !studyManufacturer) continue;\r\n        \r\n        const relatedApprovals = [];\r\n        \r\n        for (const approval of approvals) {\r\n          const approvalDeviceName = this.extractDeviceNameFromTitle(approval.title);\r\n          const approvalManufacturer = this.extractManufacturerFromContent(approval.content);\r\n          \r\n          let confidence = 0;\r\n          \r\n          if (studyDeviceName && approvalDeviceName) {\r\n            confidence = Math.max(confidence, \r\n              await this.calculateSimilarity(studyDeviceName, approvalDeviceName));\r\n          }\r\n          \r\n          if (studyManufacturer && approvalManufacturer) {\r\n            confidence = Math.max(confidence,\r\n              await this.calculateSimilarity(studyManufacturer, approvalManufacturer));\r\n          }\r\n          \r\n          if (confidence >= this.mappingThreshold) {\r\n            relatedApprovals.push(approval.id);\r\n          }\r\n        }\r\n        \r\n        if (relatedApprovals.length > 0) {\r\n          const mapping: DeviceMapping = {\r\n            primaryId: study.id,\r\n            relatedIds: relatedApprovals,\r\n            mappingType: 'clinical_study',\r\n            confidence: 0.8, // Base confidence for clinical study links\r\n            lastUpdated: new Date()\r\n          };\r\n          \r\n          clinicalMappings.push(mapping);\r\n        }\r\n      }\r\n      \r\n      console.log(`[CrossRef] Created ${clinicalMappings.length} clinical study mappings`);\r\n      return clinicalMappings;\r\n    } catch (error) {\r\n      console.error('[CrossRef] Error linking clinical studies:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async generateComprehensiveCrossReference(): Promise<{\r\n    deviceMappings: DeviceMapping[];\r\n    standardMappings: StandardMapping[];\r\n    clinicalMappings: DeviceMapping[];\r\n    totalMappings: number;\r\n  }> {\r\n    try {\r\n      console.log('[CrossRef] Generating comprehensive cross-reference database');\r\n      \r\n      const [deviceMappings, standardMappings, clinicalMappings] = await Promise.all([\r\n        this.mapDevicesBetweenJurisdictions(),\r\n        this.mapStandardsToRegulations(),\r\n        this.linkClinicalStudiesToApprovals()\r\n      ]);\r\n      \r\n      const totalMappings = deviceMappings.length + standardMappings.length + clinicalMappings.length;\r\n      \r\n      console.log(`[CrossRef] Generated comprehensive cross-reference with ${totalMappings} total mappings`);\r\n      \r\n      return {\r\n        deviceMappings,\r\n        standardMappings,\r\n        clinicalMappings,\r\n        totalMappings\r\n      };\r\n    } catch (error) {\r\n      console.error('[CrossRef] Error generating cross-reference:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}"]}