{"version":3,"file":"auth-routes.js","sourceRoot":"","sources":["../../server/routes/auth-routes.ts"],"names":[],"mappings":"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","sourcesContent":["import express from 'express';\r\n// Simple password validation for demo (replace with bcrypt in production)\r\nimport { neon } from \"@neondatabase/serverless\";\r\nimport { TenantRequest } from '../middleware/tenant-isolation';\r\n\r\nconst router = express.Router();\r\nconst sql = neon(process.env.DATABASE_URL!);\r\n\r\n/**\r\n * Tenant Login\r\n * Authenticates users within their tenant context\r\n */\r\nrouter.post('/login', async (req: TenantRequest, res) => {\r\n  try {\r\n    const { email, password } = req.body;\r\n    const tenantSubdomain = req.headers['x-tenant-subdomain'] as string;\r\n\r\n    if (!email || !password) {\r\n      return res.status(400).json({ \r\n        error: 'Email und Passwort sind erforderlich' \r\n      });\r\n    }\r\n\r\n    // Use demo tenant for testing (simplified)\r\n    const tenant = {\r\n      id: '2d224347-b96e-4b61-acac-dbd414a0e048',\r\n      name: 'Demo Medical Corp',\r\n      subdomain: 'demo-medical',\r\n      subscription_tier: 'professional'\r\n    };\r\n\r\n    // Find user (simplified for demo)\r\n    const userResult = await sql`\r\n      SELECT id, email, name, role, created_at\r\n      FROM users \r\n      WHERE email = ${email}\r\n    `;\r\n\r\n    const user = userResult[0];\r\n    if (!user) {\r\n      return res.status(401).json({ \r\n        error: 'Ungültige Anmeldedaten' \r\n      });\r\n    }\r\n\r\n    // Verify password (demo implementation)\r\n    const validPassword = password === 'demo123';\r\n\r\n    if (!validPassword) {\r\n      return res.status(401).json({ \r\n        error: 'Ungültige Anmeldedaten' \r\n      });\r\n    }\r\n\r\n    // Update last login (skip for demo)\r\n    try {\r\n      await sql`\r\n        UPDATE users \r\n        SET updated_at = NOW() \r\n        WHERE id = ${user.id}\r\n      `;\r\n    } catch (error) {\r\n      console.log('[AUTH] Update user login time skipped:', error.message);\r\n    }\r\n\r\n    // Create session\r\n    const sessionUser = {\r\n      id: user.id,\r\n      tenantId: tenant.id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role\r\n    };\r\n\r\n    // Store in session\r\n    if (req.session) {\r\n      req.session.user = sessionUser;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.name,\r\n        role: user.role\r\n      },\r\n      tenant: {\r\n        id: tenant.id,\r\n        name: tenant.name,\r\n        subdomain: tenant.subdomain,\r\n        colorScheme: 'blue',\r\n        subscriptionTier: tenant.subscription_tier\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[AUTH] Login error:', error);\r\n    res.status(500).json({ \r\n      error: 'Anmeldung fehlgeschlagen',\r\n      message: 'Bitte versuchen Sie es erneut oder kontaktieren Sie den Support'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * Tenant Logout\r\n */\r\nrouter.post('/logout', async (req: TenantRequest, res) => {\r\n  try {\r\n    if (req.session) {\r\n      req.session.destroy((err) => {\r\n        if (err) {\r\n          console.error('[AUTH] Logout error:', err);\r\n          return res.status(500).json({ error: 'Abmeldung fehlgeschlagen' });\r\n        }\r\n        res.json({ success: true, message: 'Erfolgreich abgemeldet' });\r\n      });\r\n    } else {\r\n      res.json({ success: true, message: 'Bereits abgemeldet' });\r\n    }\r\n  } catch (error) {\r\n    console.error('[AUTH] Logout error:', error);\r\n    res.status(500).json({ error: 'Abmeldung fehlgeschlagen' });\r\n  }\r\n});\r\n\r\n/**\r\n * Current User Profile\r\n */\r\nrouter.get('/profile', async (req: TenantRequest, res) => {\r\n  try {\r\n    if (!req.user || !req.tenant) {\r\n      return res.status(401).json({ error: 'Nicht angemeldet' });\r\n    }\r\n\r\n    res.json({\r\n      user: {\r\n        id: req.user.id,\r\n        email: req.user.email,\r\n        name: req.user.name,\r\n        role: req.user.role\r\n      },\r\n      tenant: {\r\n        id: req.tenant.id,\r\n        name: req.tenant.name,\r\n        subdomain: req.tenant.subdomain,\r\n        colorScheme: req.tenant.colorScheme,\r\n        subscriptionTier: req.tenant.subscriptionTier\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('[AUTH] Profile error:', error);\r\n    res.status(500).json({ error: 'Profil konnte nicht geladen werden' });\r\n  }\r\n});\r\n\r\nexport default router;"]}