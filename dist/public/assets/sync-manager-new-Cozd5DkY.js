import{u as P,f as U,r as N,g as f,h as v,j as e,B as b,_ as p,C as u,c as h,k as S,D as w,V as K,J as C,K as L}from"./index-Dm22qi9h.js";import{P as _}from"./play-i7-2bqnJ.js";import{D}from"./download-CQfvf7I6.js";async function j(l,r="GET",i){console.log(`[API] ${r} ${l}`,i);const c={method:r,headers:{"Content-Type":"application/json",Accept:"application/json"}};r==="POST"&&i&&(c.body=JSON.stringify(i));const n=await fetch(l,c);if(console.log(`[API] Response ${n.status} for ${l}`),!n.ok){const d=await n.text();throw new Error(`${n.status}: ${d}`)}const o=await n.json();return console.log("[API] Success:",o),o}function q(){const{toast:l}=P(),r=U(),[i,c]=N.useState({}),[n,o]=N.useState(!1),{data:d=[],isLoading:k}=f({queryKey:["/api/data-sources"],queryFn:()=>j("/api/data-sources")}),{data:x}=f({queryKey:["/api/dashboard/stats"],queryFn:()=>j("/api/dashboard/stats"),refetchInterval:5e3}),$=v({mutationFn:async s=>{console.log(`[SYNC] Starting sync for ${s}`),c(t=>({...t,[s]:"syncing"}));const a=await j(`/api/data-sources/${s}/sync`,"POST",{optimized:!0,realTime:!0});return{sourceId:s,...a}},onSuccess:s=>{console.log(`[SYNC] Success for ${s.sourceId}:`,s),c(a=>({...a,[s.sourceId]:"success"})),l({title:"✅ Synchronisation erfolgreich",description:`${s.sourceId}: ${s.message||"Synchronisation abgeschlossen"}`}),r.invalidateQueries({queryKey:["/api/data-sources"]}),r.invalidateQueries({queryKey:["/api/dashboard/stats"]})},onError:(s,a)=>{console.error(`[SYNC] Error for ${a}:`,s),c(t=>({...t,[a]:"error"})),l({title:"❌ Synchronisation fehlgeschlagen",description:`${a}: ${s.message}`,variant:"destructive"})}}),y=v({mutationFn:async()=>{console.log("[BULK SYNC] Starting bulk sync for all sources"),o(!0);const s=d.filter(t=>t.is_active||t.isActive).map(t=>t.id),a={};s.forEach(t=>a[t]="syncing"),c(a);try{const t=await fetch("/api/data-sources/sync-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({optimized:!0,backgroundProcessing:!0})});if(console.log("[BULK SYNC] Response status:",t.status),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const m=await t.json();return console.log("[BULK SYNC] Response data:",m),m}catch(t){throw console.error("[BULK SYNC] Fetch error:",t),o(!1),t}},onSuccess:s=>{console.log("[BULK SYNC] Success:",s),o(!1);const a={};d.filter(m=>m.is_active).forEach(m=>a[m.id]="success"),c(a);const t=Math.round((s.totalDuration||0)/1e3);s.totalNewUpdates>0?l({title:"✅ Bulk-Synchronisation erfolgreich",description:`${s.successful}/${s.total} Quellen: ${s.totalNewUpdates} neue Updates in ${t}s`}):l({title:"ℹ️ Bulk-Synchronisation abgeschlossen",description:`${s.successful}/${s.total} Quellen überprüft: Keine neuen Updates in ${t}s`}),r.invalidateQueries({queryKey:["/api/data-sources"]}),r.invalidateQueries({queryKey:["/api/dashboard/stats"]})},onError:s=>{console.error("[BULK SYNC] Error:",s),o(!1),c({}),l({title:"❌ Bulk-Synchronisation fehlgeschlagen",description:`Fehler: ${s.message}`,variant:"destructive"})}}),B=s=>{switch(i[s]||"idle"){case"syncing":return e.jsx(p,{className:"h-4 w-4 animate-spin text-blue-500"});case"success":return e.jsx(S,{className:"h-4 w-4 text-green-500"});case"error":return e.jsx(L,{className:"h-4 w-4 text-red-500"});default:return e.jsx(w,{className:"h-4 w-4 text-gray-500"})}},A=s=>{switch(i[s]||"idle"){case"syncing":return"border-blue-200 bg-blue-50";case"success":return"border-green-200 bg-green-50";case"error":return"border-red-200 bg-red-50";default:return"border-gray-200 bg-white"}};if(k)return e.jsx("div",{className:"p-6 space-y-6",children:e.jsx("div",{className:"animate-pulse space-y-4",children:[...Array(6)].map((s,a)=>e.jsx("div",{className:"h-32 bg-gray-200 rounded-lg"},a))})});const g=d.filter(s=>s.is_active||s.isActive);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Datenquellen-Synchronisation"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300 mt-2",children:["Neue, saubere Frontend-Backend Verbindung - ",g.length," aktive Quellen"]})]}),e.jsxs(b,{onClick:()=>{console.log("[UI] Bulk sync button clicked"),console.log("[UI] Current mutation state:",{isActive:n,isPending:y.isPending}),y.mutate()},disabled:n||y.isPending,className:"bg-[#d95d2c] hover:bg-[#b8441f] text-white",children:[n?e.jsx(p,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(_,{className:"h-4 w-4 mr-2"}),"Alle synchronisieren (",g.length,")"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Aktive Quellen"}),e.jsx("p",{className:"font-semibold text-green-600",children:g.length})]})]})})}),e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Updates Gesamt"}),e.jsx("p",{className:"font-semibold text-blue-600",children:(x==null?void 0:x.totalUpdates)||0})]})]})})}),e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(D,{className:"h-5 w-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Legal Cases"}),e.jsx("p",{className:"font-semibold text-purple-600",children:(x==null?void 0:x.totalLegalCases)||0})]})]})})}),e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-5 w-5 text-orange-600"}),e.jsx("div",{children:e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Approvals"})})]})})})]}),n&&e.jsx(u,{className:"border-blue-200 bg-blue-50",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{className:"h-5 w-5 animate-spin text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-blue-800",children:"Bulk-Synchronisation läuft..."}),e.jsxs("p",{className:"text-sm text-blue-600",children:[Object.values(i).filter(s=>s==="success").length," von ",g.length," Quellen abgeschlossen"]})]})]})})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:d.map(s=>e.jsx(u,{className:`${A(s.id)} transition-all duration-300`,children:e.jsxs(h,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[B(s.id),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ID: ",s.id]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(C,{variant:s.is_active||s.isActive?"default":"secondary",children:s.is_active||s.isActive?"Aktiv":"Inaktiv"}),s.type&&e.jsx(C,{variant:"outline",children:s.type})]})]}),(s.last_sync||s.lastSync||s.last_sync_at)&&e.jsxs("p",{className:"text-xs text-gray-500 mb-3",children:["Letzte Sync: ",new Date(s.last_sync||s.lastSync||s.last_sync_at||"").toLocaleString("de-DE")]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Status: ",i[s.id]||"Bereit"]}),e.jsx(b,{size:"sm",onClick:()=>{console.log(`[UI] Single sync clicked for ${s.id}`),$.mutate(s.id)},disabled:!(s.is_active||s.isActive)||i[s.id]==="syncing",variant:"outline",children:i[s.id]==="syncing"?e.jsx(p,{className:"h-3 w-3 animate-spin"}):"Synchronisieren"})]})]})},s.id))}),e.jsx(u,{className:"border-gray-200 bg-gray-50",children:e.jsxs(h,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Debug Information"}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("p",{children:["Geladene Datenquellen: ",d.length]}),e.jsxs("p",{children:["Aktive Quellen: ",g.length]}),e.jsxs("p",{children:["Bulk Sync Status: ",n?"Läuft":"Bereit"]}),e.jsxs("p",{children:["Dashboard Stats: ",x?"Geladen":"Lädt..."]})]})]})})]})}export{q as default};
