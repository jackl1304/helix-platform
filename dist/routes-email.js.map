{"version":3,"file":"routes-email.js","sourceRoot":"","sources":["../server/routes-email.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,MAAM,yBAAyB,CAAC;AAEvD,MAAM,UAAU,mBAAmB,CAAC,GAAY;IAE9C,GAAG,CAAC,GAAG,CAAC,sBAAsB,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;QACjD,IAAI,CAAC;YACH,MAAM,aAAa,GAAG;gBACpB,EAAE,EAAE,iBAAiB;gBACrB,IAAI,EAAE,sCAAsC;gBAC5C,IAAI,EAAE,gBAAgB;gBACtB,IAAI,EAAE,GAAG;gBACT,MAAM,EAAE,KAAK;gBACb,IAAI,EAAE,8BAA8B;gBACpC,MAAM,EAAE,QAAQ;gBAChB,UAAU,EAAE,GAAG;gBACf,SAAS,EAAE,CAAC;gBACZ,QAAQ,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;aACnC,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;QAC5B,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,iCAAiC,EAAE,CAAC,CAAC;QACvE,CAAC;IACH,CAAC,CAAC,CAAC;IAGH,GAAG,CAAC,GAAG,CAAC,sBAAsB,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;QACjD,IAAI,CAAC;YACH,MAAM,cAAc,GAAG;gBACrB;oBACE,EAAE,EAAE,qBAAqB;oBACzB,IAAI,EAAE,kBAAkB;oBACxB,OAAO,EAAE,+CAA+C;oBACxD,OAAO,EAAE,oDAAoD;oBAC7D,IAAI,EAAE,qBAAqB;oBAC3B,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,cAAc,EAAE,kBAAkB,EAAE,UAAU,CAAC;iBAC5D;gBACD;oBACE,EAAE,EAAE,sBAAsB;oBAC1B,IAAI,EAAE,kBAAkB;oBACxB,OAAO,EAAE,8CAA8C;oBACvD,OAAO,EAAE,+CAA+C;oBACxD,IAAI,EAAE,sBAAsB;oBAC5B,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,cAAc,EAAE,kBAAkB,EAAE,SAAS,CAAC;iBAC3D;gBACD;oBACE,EAAE,EAAE,kBAAkB;oBACtB,IAAI,EAAE,qBAAqB;oBAC3B,OAAO,EAAE,sCAAsC;oBAC/C,OAAO,EAAE,6CAA6C;oBACtD,IAAI,EAAE,kBAAkB;oBACxB,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,cAAc,EAAE,QAAQ,EAAE,SAAS,EAAE,YAAY,CAAC;iBAC/D;gBACD;oBACE,EAAE,EAAE,kBAAkB;oBACtB,IAAI,EAAE,kBAAkB;oBACxB,OAAO,EAAE,sCAAsC;oBAC/C,OAAO,EAAE,wCAAwC;oBACjD,IAAI,EAAE,kBAAkB;oBACxB,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,YAAY,EAAE,SAAS,EAAE,SAAS,EAAE,cAAc,CAAC;iBAChE;gBACD;oBACE,EAAE,EAAE,eAAe;oBACnB,IAAI,EAAE,sBAAsB;oBAC5B,OAAO,EAAE,wBAAwB;oBACjC,OAAO,EAAE,2CAA2C;oBACpD,IAAI,EAAE,eAAe;oBACrB,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,cAAc,EAAE,iBAAiB,EAAE,cAAc,CAAC;iBAC/D;gBACD;oBACE,EAAE,EAAE,cAAc;oBAClB,IAAI,EAAE,oBAAoB;oBAC1B,OAAO,EAAE,yCAAyC;oBAClD,OAAO,EAAE,iCAAiC;oBAC1C,IAAI,EAAE,cAAc;oBACpB,QAAQ,EAAE,IAAI;oBACd,SAAS,EAAE,CAAC,cAAc,EAAE,YAAY,EAAE,YAAY,CAAC;iBACxD;aACF,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QAC3B,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,iCAAiC,EAAE,CAAC,CAAC;QACvE,CAAC;IACH,CAAC,CAAC,CAAC;IAGH,GAAG,CAAC,GAAG,CAAC,uBAAuB,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;QAClD,IAAI,CAAC;YACH,MAAM,KAAK,GAAG;gBACZ,SAAS,EAAE,CAAC;gBACZ,cAAc,EAAE,CAAC;gBACjB,WAAW,EAAE,CAAC;gBACd,SAAS,EAAE,CAAC;gBACZ,uBAAuB,EAAE,GAAG;gBAC5B,uBAAuB,EAAE,GAAG;gBAC5B,QAAQ,EAAE,IAAI;aACf,CAAC;YAEF,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAClB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,kCAAkC,EAAE,CAAC,CAAC;QACxE,CAAC;IACH,CAAC,CAAC,CAAC;IAGH,GAAG,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;QAC7C,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,YAAY,CAAC,cAAc,EAAE,CAAC;YAGnD,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACnB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,OAAO,CAAC,KAAK,CAAC,gCAAgC,EAAE,KAAK,CAAC,CAAC;YACvD,GAAG,CAAC,IAAI,CAAC;gBACP,OAAO,EAAE,KAAK;gBACd,SAAS,EAAE,KAAK;gBAChB,OAAO,EAAE,iCAAiC;gBAC1C,OAAO,EAAE,KAAK,CAAC,OAAO,IAAI,uCAAuC;gBACjE,QAAQ,EAAE,sCAAsC;aACjD,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC,CAAC;IAGH,GAAG,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;QAC7C,IAAI,CAAC;YACH,MAAM,EAAE,EAAE,EAAE,UAAU,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;YAG/C,IAAI,OAAO,GAAG,EAAE,CAAC;YACjB,IAAI,OAAO,GAAG,EAAE,CAAC;YAEjB,QAAQ,UAAU,EAAE,CAAC;gBACnB,KAAK,qBAAqB;oBACxB,MAAM,UAAU,GAAG,YAAY,CAAC,+BAA+B,CAC7D,SAAS,CAAC,YAAY,IAAI,OAAO,EACjC,SAAS,CAAC,gBAAgB,IAAI,cAAc,EAC5C,SAAS,CAAC,QAAQ,IAAI,kCAAkC,CACzD,CAAC;oBACF,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC;oBAC7B,OAAO,GAAG,UAAU,CAAC,IAAI,CAAC;oBAC1B,MAAM;gBAER,KAAK,sBAAsB;oBACzB,MAAM,WAAW,GAAG,YAAY,CAAC,gCAAgC,CAC/D,SAAS,CAAC,YAAY,IAAI,OAAO,EACjC,SAAS,CAAC,gBAAgB,IAAI,cAAc,EAC5C,SAAS,CAAC,OAAO,IAAI,YAAY,CAClC,CAAC;oBACF,OAAO,GAAG,WAAW,CAAC,OAAO,CAAC;oBAC9B,OAAO,GAAG,WAAW,CAAC,IAAI,CAAC;oBAC3B,MAAM;gBAER,KAAK,kBAAkB;oBACrB,MAAM,OAAO,GAAG,YAAY,CAAC,4BAA4B,CACvD,SAAS,CAAC,YAAY,IAAI,OAAO,EACjC,SAAS,CAAC,MAAM,IAAI,KAAK,EACzB,SAAS,CAAC,OAAO,IAAI,YAAY,EACjC,SAAS,CAAC,UAAU,IAAI,oCAAoC,CAC7D,CAAC;oBACF,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC;oBAC1B,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC;oBACvB,MAAM;gBAER,KAAK,kBAAkB;oBACrB,MAAM,KAAK,GAAG,YAAY,CAAC,4BAA4B,CACrD,SAAS,CAAC,UAAU,IAAI,8BAA8B,EACtD,SAAS,CAAC,OAAO,IAAI,mCAAmC,EACxD,SAAS,CAAC,OAAO,IAAI,QAAQ,EAC7B,SAAS,CAAC,YAAY,IAAI,sCAAsC,CACjE,CAAC;oBACF,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC;oBACxB,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC;oBACrB,MAAM;gBAER,KAAK,eAAe;oBAClB,MAAM,MAAM,GAAG,YAAY,CAAC,yBAAyB,CACnD,SAAS,CAAC,YAAY,IAAI,OAAO,EACjC,QAAQ,CAAC,SAAS,CAAC,YAAY,CAAC,IAAI,EAAE,EACtC,QAAQ,CAAC,SAAS,CAAC,eAAe,CAAC,IAAI,EAAE,EACzC,SAAS,CAAC,YAAY,IAAI,sCAAsC,CACjE,CAAC;oBACF,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;oBACzB,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC;oBACtB,MAAM;gBAER,KAAK,cAAc;oBACjB,MAAM,KAAK,GAAG,YAAY,CAAC,wBAAwB,CACjD,SAAS,CAAC,YAAY,IAAI,OAAO,EACjC,SAAS,CAAC,UAAU,IAAI,YAAY,EACpC,SAAS,CAAC,UAAU,IAAI,oCAAoC,CAC7D,CAAC;oBACF,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC;oBACxB,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC;oBACrB,MAAM;gBAER;oBACE,OAAO,GAAG,mBAAmB,CAAC;oBAC9B,OAAO,GAAG,6CAA6C,CAAC;YAC5D,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,YAAY,CAAC,SAAS,CAAC,EAAE,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;YAElE,IAAI,MAAM,EAAE,CAAC;gBACX,GAAG,CAAC,IAAI,CAAC;oBACP,OAAO,EAAE,IAAI;oBACb,SAAS,EAAE,SAAS,IAAI,CAAC,GAAG,EAAE,EAAE;oBAChC,OAAO,EAAE,8BAA8B;iBACxC,CAAC,CAAC;YACL,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBACnB,OAAO,EAAE,KAAK;oBACd,OAAO,EAAE,+BAA+B;iBACzC,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,KAAK;gBACd,OAAO,EAAE,mCAAmC;aAC7C,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import type { Express } from \"express\";\r\nimport { emailService } from \"./services/emailService\";\r\n\r\nexport function registerEmailRoutes(app: Express) {\r\n  // Gmail Provider API - Only authentic Gmail integration\r\n  app.get('/api/email/providers', async (req, res) => {\r\n    try {\r\n      const gmailProvider = {\r\n        id: 'gmail_deltaways',\r\n        name: 'Gmail (deltawayshelixinfo@gmail.com)',\r\n        host: 'smtp.gmail.com',\r\n        port: 587,\r\n        secure: false,\r\n        user: 'deltawayshelixinfo@gmail.com',\r\n        status: 'active', // Gmail mit App-Passwort verbunden\r\n        dailyLimit: 500,\r\n        usedToday: 0,\r\n        lastTest: new Date().toISOString()\r\n      };\r\n      \r\n      res.json([gmailProvider]);\r\n    } catch (error) {\r\n      res.status(500).json({ message: 'Failed to fetch email providers' });\r\n    }\r\n  });\r\n\r\n  // Gmail Templates API - Professional templates only\r\n  app.get('/api/email/templates', async (req, res) => {\r\n    try {\r\n      const gmailTemplates = [\r\n        {\r\n          id: 'customer_onboarding',\r\n          name: 'Kunden Anmeldung',\r\n          subject: 'Willkommen bei Helix Regulatory Intelligence!',\r\n          content: 'Vollständiges Onboarding-Template mit Anmeldedaten',\r\n          type: 'customer_onboarding',\r\n          isActive: true,\r\n          variables: ['customerName', 'subscriptionPlan', 'loginUrl']\r\n        },\r\n        {\r\n          id: 'customer_offboarding',\r\n          name: 'Kunden Abmeldung',\r\n          subject: 'Abschied von Helix - Danke für Ihr Vertrauen',\r\n          content: 'Höfliche Abmeldung mit Reaktivierungsoptionen',\r\n          type: 'customer_offboarding',\r\n          isActive: true,\r\n          variables: ['customerName', 'subscriptionPlan', 'endDate']\r\n        },\r\n        {\r\n          id: 'billing_reminder',\r\n          name: 'Rechnungserinnerung',\r\n          subject: 'Zahlungserinnerung - Rechnung fällig',\r\n          content: 'Freundliche Erinnerung mit Zahlungsoptionen',\r\n          type: 'billing_reminder',\r\n          isActive: true,\r\n          variables: ['customerName', 'amount', 'dueDate', 'invoiceUrl']\r\n        },\r\n        {\r\n          id: 'regulatory_alert',\r\n          name: 'Regulatory Alert',\r\n          subject: '🚨 Neues kritisches Update verfügbar',\r\n          content: 'Alert-Template für wichtige Änderungen',\r\n          type: 'regulatory_alert',\r\n          isActive: true,\r\n          variables: ['alertTitle', 'summary', 'urgency', 'dashboardUrl']\r\n        },\r\n        {\r\n          id: 'weekly_digest',\r\n          name: 'Wöchentlicher Digest',\r\n          subject: '📊 Helix Weekly Digest',\r\n          content: 'Zusammenfassung der Woche mit Statistiken',\r\n          type: 'weekly_digest',\r\n          isActive: true,\r\n          variables: ['updatesCount', 'legalCasesCount', 'dashboardUrl']\r\n        },\r\n        {\r\n          id: 'trial_expiry',\r\n          name: 'Testphase läuft ab',\r\n          subject: '⏰ Ihre Helix Testphase endet in 3 Tagen',\r\n          content: 'Erinnerung mit Upgrade-Optionen',\r\n          type: 'trial_expiry',\r\n          isActive: true,\r\n          variables: ['customerName', 'expiryDate', 'upgradeUrl']\r\n        }\r\n      ];\r\n      \r\n      res.json(gmailTemplates);\r\n    } catch (error) {\r\n      res.status(500).json({ message: 'Failed to fetch email templates' });\r\n    }\r\n  });\r\n\r\n  // Gmail Statistics API\r\n  app.get('/api/email/statistics', async (req, res) => {\r\n    try {\r\n      const stats = {\r\n        totalSent: 0,\r\n        totalDelivered: 0,\r\n        totalFailed: 0,\r\n        dailySent: 0,\r\n        weeklyDigestSubscribers: 847,\r\n        instantAlertSubscribers: 234,\r\n        lastSent: null\r\n      };\r\n      \r\n      res.json(stats);\r\n    } catch (error) {\r\n      res.status(500).json({ message: 'Failed to fetch email statistics' });\r\n    }\r\n  });\r\n\r\n  // Gmail Connection Test\r\n  app.post('/api/email/test', async (req, res) => {\r\n    try {\r\n      const result = await emailService.testConnection();\r\n      \r\n      // Service now returns proper JSON object\r\n      res.json(result);\r\n    } catch (error) {\r\n      console.error('[EMAIL] Connection test error:', error);\r\n      res.json({\r\n        success: false,\r\n        connected: false,\r\n        message: 'Gmail-Verbindung fehlgeschlagen',\r\n        details: error.message || 'Unbekannter Fehler bei der Verbindung',\r\n        provider: 'Gmail (deltawayshelixinfo@gmail.com)'\r\n      });\r\n    }\r\n  });\r\n\r\n  // Send Email via Gmail\r\n  app.post('/api/email/send', async (req, res) => {\r\n    try {\r\n      const { to, templateId, variables } = req.body;\r\n      \r\n      // Generate email content based on template\r\n      let subject = '';\r\n      let content = '';\r\n      \r\n      switch (templateId) {\r\n        case 'customer_onboarding':\r\n          const onboarding = emailService.generateCustomerOnboardingEmail(\r\n            variables.customerName || 'Kunde',\r\n            variables.subscriptionPlan || 'Professional',\r\n            variables.loginUrl || 'https://helix-platform.com/login'\r\n          );\r\n          subject = onboarding.subject;\r\n          content = onboarding.html;\r\n          break;\r\n          \r\n        case 'customer_offboarding':\r\n          const offboarding = emailService.generateCustomerOffboardingEmail(\r\n            variables.customerName || 'Kunde',\r\n            variables.subscriptionPlan || 'Professional',\r\n            variables.endDate || '31.12.2025'\r\n          );\r\n          subject = offboarding.subject;\r\n          content = offboarding.html;\r\n          break;\r\n          \r\n        case 'billing_reminder':\r\n          const billing = emailService.generateBillingReminderEmail(\r\n            variables.customerName || 'Kunde',\r\n            variables.amount || '299',\r\n            variables.dueDate || '31.12.2025',\r\n            variables.invoiceUrl || 'https://helix-platform.com/invoice'\r\n          );\r\n          subject = billing.subject;\r\n          content = billing.html;\r\n          break;\r\n          \r\n        case 'regulatory_alert':\r\n          const alert = emailService.generateRegulatoryAlertEmail(\r\n            variables.alertTitle || 'Neue regulatorische Änderung',\r\n            variables.summary || 'Wichtige Aktualisierung verfügbar',\r\n            variables.urgency || 'medium',\r\n            variables.dashboardUrl || 'https://helix-platform.com/dashboard'\r\n          );\r\n          subject = alert.subject;\r\n          content = alert.html;\r\n          break;\r\n          \r\n        case 'weekly_digest':\r\n          const digest = emailService.generateWeeklyDigestEmail(\r\n            variables.customerName || 'Kunde',\r\n            parseInt(variables.updatesCount) || 12,\r\n            parseInt(variables.legalCasesCount) || 65,\r\n            variables.dashboardUrl || 'https://helix-platform.com/dashboard'\r\n          );\r\n          subject = digest.subject;\r\n          content = digest.html;\r\n          break;\r\n          \r\n        case 'trial_expiry':\r\n          const trial = emailService.generateTrialExpiryEmail(\r\n            variables.customerName || 'Kunde',\r\n            variables.expiryDate || '31.12.2025',\r\n            variables.upgradeUrl || 'https://helix-platform.com/upgrade'\r\n          );\r\n          subject = trial.subject;\r\n          content = trial.html;\r\n          break;\r\n          \r\n        default:\r\n          subject = 'Helix Test-E-Mail';\r\n          content = '<p>Dies ist eine Test-E-Mail von Helix.</p>';\r\n      }\r\n      \r\n      const result = await emailService.sendEmail(to, subject, content);\r\n      \r\n      if (result) {\r\n        res.json({\r\n          success: true,\r\n          messageId: `helix_${Date.now()}`,\r\n          message: 'E-Mail erfolgreich versendet'\r\n        });\r\n      } else {\r\n        res.status(400).json({\r\n          success: false,\r\n          message: 'E-Mail-Versand fehlgeschlagen'\r\n        });\r\n      }\r\n    } catch (error) {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Server-Fehler beim E-Mail-Versand'\r\n      });\r\n    }\r\n  });\r\n}"]}