{"version":3,"file":"duplicateCleanupService.js","sourceRoot":"","sources":["../../../server/services/duplicateCleanupService.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from './logger.service';\r\nimport { storage } from '../storage';\r\nimport { neon } from \"@neondatabase/serverless\";\r\n\r\nconst sql = neon(process.env.DATABASE_URL!);\r\n\r\ninterface DuplicateCleanupStats {\r\n  totalRecords: number;\r\n  uniqueRecords: number;\r\n  duplicatesRemoved: number;\r\n  cleanupTime: number;\r\n  qualityImprovement: number;\r\n}\r\n\r\nexport class DuplicateCleanupService {\r\n  private logger = new Logger('DuplicateCleanupService');\r\n\r\n  /**\r\n   * KRITISCHE DUPLIKATE-BEREINIGUNG\r\n   * Entfernt massive Duplikate basierend auf Title-Hash\r\n   */\r\n  async performEmergencyDuplicateCleanup(): Promise<DuplicateCleanupStats> {\r\n    const startTime = Date.now();\r\n    this.logger.info('STARTING EMERGENCY DUPLICATE CLEANUP - System has 95.5% duplicates!');\r\n\r\n    try {\r\n      // 1. Aktuelle Situation analysieren\r\n      const beforeStats = await this.getDuplicateStats();\r\n      this.logger.info('Before cleanup statistics', beforeStats);\r\n\r\n      // 2. Duplikate in Regulatory Updates bereinigen\r\n      const regulatoryCleanup = await this.cleanupRegulatoryUpdateDuplicates();\r\n      \r\n      // 3. Duplikate in Legal Cases bereinigen\r\n      const legalCleanup = await this.cleanupLegalCaseDuplicates();\r\n\r\n      // 4. Nach-Bereinigung Statistiken\r\n      const afterStats = await this.getDuplicateStats();\r\n      this.logger.info('After cleanup statistics', afterStats);\r\n\r\n      const cleanupTime = Date.now() - startTime;\r\n      const totalRemoved = regulatoryCleanup.removed + legalCleanup.removed;\r\n      const qualityImprovement = ((afterStats.uniquenessRatio - beforeStats.uniquenessRatio) * 100);\r\n\r\n      const stats: DuplicateCleanupStats = {\r\n        totalRecords: afterStats.totalRegulatory + afterStats.totalLegal,\r\n        uniqueRecords: afterStats.uniqueRegulatory + afterStats.uniqueLegal,\r\n        duplicatesRemoved: totalRemoved,\r\n        cleanupTime,\r\n        qualityImprovement\r\n      };\r\n\r\n      this.logger.info('EMERGENCY DUPLICATE CLEANUP COMPLETED', stats);\r\n      return stats;\r\n\r\n    } catch (error: any) {\r\n      this.logger.error('Emergency duplicate cleanup failed', { error: error.message });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Bereinigt Duplikate in Regulatory Updates\r\n   */\r\n  private async cleanupRegulatoryUpdateDuplicates(): Promise<{ kept: number; removed: number }> {\r\n    this.logger.info('Cleaning regulatory updates duplicates...');\r\n\r\n    // Strategie: Behalte das neueste Update pro eindeutigem Titel\r\n    const duplicateQuery = `\r\n      WITH duplicate_groups AS (\r\n        SELECT \r\n          id,\r\n          title,\r\n          published_at,\r\n          ROW_NUMBER() OVER (\r\n            PARTITION BY LOWER(TRIM(title)) \r\n            ORDER BY published_at DESC, created_at DESC\r\n          ) as row_num\r\n        FROM regulatory_updates\r\n        WHERE title IS NOT NULL AND TRIM(title) != ''\r\n      ),\r\n      duplicates_to_delete AS (\r\n        SELECT id FROM duplicate_groups WHERE row_num > 1\r\n      )\r\n      DELETE FROM regulatory_updates \r\n      WHERE id IN (SELECT id FROM duplicates_to_delete)\r\n    `;\r\n\r\n    const result = await sql(duplicateQuery);\r\n    const removed = Array.isArray(result) ? result.length : 0;\r\n\r\n    // Aktuelle Anzahl nach Bereinigung\r\n    const remaining = await sql`SELECT COUNT(*) as count FROM regulatory_updates`;\r\n    const kept = parseInt(remaining[0]?.count || '0');\r\n\r\n    this.logger.info('Regulatory updates cleanup completed', { kept, removed });\r\n    return { kept, removed };\r\n  }\r\n\r\n  /**\r\n   * Bereinigt Duplikate in Legal Cases\r\n   */\r\n  private async cleanupLegalCaseDuplicates(): Promise<{ kept: number; removed: number }> {\r\n    this.logger.info('Cleaning legal cases duplicates...');\r\n\r\n    // Strategie: Behalte den neuesten Case pro eindeutigem Titel\r\n    const duplicateQuery = `\r\n      WITH duplicate_groups AS (\r\n        SELECT \r\n          id,\r\n          title,\r\n          decision_date,\r\n          ROW_NUMBER() OVER (\r\n            PARTITION BY LOWER(TRIM(title)) \r\n            ORDER BY decision_date DESC, created_at DESC\r\n          ) as row_num\r\n        FROM legal_cases\r\n        WHERE title IS NOT NULL AND TRIM(title) != ''\r\n      ),\r\n      duplicates_to_delete AS (\r\n        SELECT id FROM duplicate_groups WHERE row_num > 1\r\n      )\r\n      DELETE FROM legal_cases \r\n      WHERE id IN (SELECT id FROM duplicates_to_delete)\r\n    `;\r\n\r\n    const result = await sql(duplicateQuery);\r\n    const removed = Array.isArray(result) ? result.length : 0;\r\n\r\n    // Aktuelle Anzahl nach Bereinigung\r\n    const remaining = await sql`SELECT COUNT(*) as count FROM legal_cases`;\r\n    const kept = parseInt(remaining[0]?.count || '0');\r\n\r\n    this.logger.info('Legal cases cleanup completed', { kept, removed });\r\n    return { kept, removed };\r\n  }\r\n\r\n  /**\r\n   * Analysiert aktuelle Duplikate-Situation\r\n   */\r\n  async getDuplicateStats(): Promise<{\r\n    totalRegulatory: number;\r\n    uniqueRegulatory: number;\r\n    totalLegal: number;\r\n    uniqueLegal: number;\r\n    uniquenessRatio: number;\r\n  }> {\r\n    const [regulatoryStats, legalStats] = await Promise.all([\r\n      sql`SELECT \r\n        COUNT(*) as total_count,\r\n        COUNT(DISTINCT LOWER(TRIM(title))) as unique_count\r\n      FROM regulatory_updates\r\n      WHERE title IS NOT NULL AND TRIM(title) != ''`,\r\n      sql`SELECT \r\n        COUNT(*) as total_count,\r\n        COUNT(DISTINCT LOWER(TRIM(title))) as unique_count\r\n      FROM legal_cases\r\n      WHERE title IS NOT NULL AND TRIM(title) != ''`\r\n    ]);\r\n\r\n    const totalRegulatory = parseInt(regulatoryStats[0]?.total_count || '0');\r\n    const uniqueRegulatory = parseInt(regulatoryStats[0]?.unique_count || '0');\r\n    const totalLegal = parseInt(legalStats[0]?.total_count || '0');\r\n    const uniqueLegal = parseInt(legalStats[0]?.unique_count || '0');\r\n\r\n    const totalRecords = totalRegulatory + totalLegal;\r\n    const uniqueRecords = uniqueRegulatory + uniqueLegal;\r\n    const uniquenessRatio = totalRecords > 0 ? uniqueRecords / totalRecords : 0;\r\n\r\n    return {\r\n      totalRegulatory,\r\n      uniqueRegulatory,\r\n      totalLegal,\r\n      uniqueLegal,\r\n      uniquenessRatio\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Erstellt Duplikate-Bereinigungsbericht\r\n   */\r\n  async generateCleanupReport(): Promise<any> {\r\n    const stats = await this.getDuplicateStats();\r\n    const duplicateRatio = stats.totalRegulatory > 0 ? \r\n      ((stats.totalRegulatory - stats.uniqueRegulatory) / stats.totalRegulatory * 100) : 0;\r\n\r\n    return {\r\n      currentStats: stats,\r\n      duplicatePercentage: Math.round(duplicateRatio * 100) / 100,\r\n      recommendedAction: duplicateRatio > 10 ? 'IMMEDIATE_CLEANUP_REQUIRED' : 'MONITORING',\r\n      qualityScore: Math.round((stats.uniquenessRatio * 100) * 100) / 100,\r\n      generatedAt: new Date().toISOString()\r\n    };\r\n  }\r\n}\r\n\r\nexport const duplicateCleanupService = new DuplicateCleanupService();"]}