{"version":3,"file":"vite.js","sourceRoot":"","sources":["../../server/vite.ts"],"names":[],"mappings":"AAAA,OAAO,OAAyB,MAAM,SAAS,CAAC;AAChD,OAAO,EAAE,MAAM,IAAI,CAAC;AACpB,OAAO,IAAI,MAAM,MAAM,CAAC;AACxB,OAAO,EAAE,YAAY,IAAI,gBAAgB,EAAE,YAAY,EAAE,MAAM,MAAM,CAAC;AAEtE,OAAO,UAAU,MAAM,gBAAgB,CAAC;AACxC,OAAO,EAAE,MAAM,EAAE,MAAM,QAAQ,CAAC;AAEhC,MAAM,UAAU,GAAG,YAAY,EAAE,CAAC;AAElC,MAAM,UAAU,GAAG,CAAC,OAAe,EAAE,MAAM,GAAG,SAAS;IACrD,MAAM,aAAa,GAAG,IAAI,IAAI,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE;QAC3D,IAAI,EAAE,SAAS;QACf,MAAM,EAAE,SAAS;QACjB,MAAM,EAAE,SAAS;QACjB,MAAM,EAAE,IAAI;KACb,CAAC,CAAC;AAGL,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,SAAS,CAAC,GAAY,EAAE,MAAc;IAC1D,MAAM,aAAa,GAAG;QACpB,cAAc,EAAE,IAAI;QACpB,GAAG,EAAE,EAAE,MAAM,EAAE;QACf,YAAY,EAAE,IAAa;KAC5B,CAAC;IAEF,MAAM,IAAI,GAAG,MAAM,gBAAgB,CAAC;QAClC,GAAG,UAAU;QACb,UAAU,EAAE,KAAK;QACjB,YAAY,EAAE;YACZ,GAAG,UAAU;YACb,KAAK,EAAE,CAAC,GAAG,EAAE,OAAO,EAAE,EAAE;gBACtB,UAAU,CAAC,KAAK,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;gBAC/B,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAClB,CAAC;SACF;QACD,MAAM,EAAE,aAAa;QACrB,OAAO,EAAE,QAAQ;KAClB,CAAC,CAAC;IAEH,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAC1B,GAAG,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;QACpC,MAAM,GAAG,GAAG,GAAG,CAAC,WAAW,CAAC;QAE5B,IAAI,CAAC;YACH,MAAM,cAAc,GAAG,IAAI,CAAC,OAAO,CACjC,MAAM,CAAC,IAAI,CAAC,OAAO,EACnB,IAAI,EACJ,QAAQ,EACR,YAAY,CACb,CAAC;YAGF,IAAI,QAAQ,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,cAAc,EAAE,OAAO,CAAC,CAAC;YACnE,QAAQ,GAAG,QAAQ,CAAC,OAAO,CACzB,qBAAqB,EACrB,wBAAwB,MAAM,EAAE,GAAG,CACpC,CAAC;YACF,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;YAC1D,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,cAAc,EAAE,WAAW,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QACjE,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,IAAI,CAAC,gBAAgB,CAAC,CAAU,CAAC,CAAC;YAClC,IAAI,CAAC,CAAC,CAAC,CAAC;QACV,CAAC;IACH,CAAC,CAAC,CAAC;AACL,CAAC;AAED,MAAM,UAAU,WAAW,CAAC,GAAY;IACtC,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;IAE7D,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC;QAC7B,MAAM,IAAI,KAAK,CACb,uCAAuC,QAAQ,uCAAuC,CACvF,CAAC;IACJ,CAAC;IAED,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC;IAGlC,GAAG,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,IAAI,EAAE,GAAG,EAAE,EAAE;QACzB,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import express, { type Express } from \"express\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport { createServer as createViteServer, createLogger } from \"vite\";\r\nimport { type Server } from \"http\";\r\nimport viteConfig from \"../vite.config\";\r\nimport { nanoid } from \"nanoid\";\r\n\r\nconst viteLogger = createLogger();\r\n\r\nexport function log(message: string, source = \"express\") {\r\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\r\n    hour: \"numeric\",\r\n    minute: \"2-digit\",\r\n    second: \"2-digit\",\r\n    hour12: true,\r\n  });\r\n\r\n  // console.log(`${formattedTime} [${source}] ${message}`);\r\n}\r\n\r\nexport async function setupVite(app: Express, server: Server) {\r\n  const serverOptions = {\r\n    middlewareMode: true,\r\n    hmr: { server },\r\n    allowedHosts: true as const,\r\n  };\r\n\r\n  const vite = await createViteServer({\r\n    ...viteConfig,\r\n    configFile: false,\r\n    customLogger: {\r\n      ...viteLogger,\r\n      error: (msg, options) => {\r\n        viteLogger.error(msg, options);\r\n        process.exit(1);\r\n      },\r\n    },\r\n    server: serverOptions,\r\n    appType: \"custom\",\r\n  });\r\n\r\n  app.use(vite.middlewares);\r\n  app.use(\"*\", async (req, res, next) => {\r\n    const url = req.originalUrl;\r\n\r\n    try {\r\n      const clientTemplate = path.resolve(\r\n        import.meta.dirname,\r\n        \"..\",\r\n        \"client\",\r\n        \"index.html\",\r\n      );\r\n\r\n      // always reload the index.html file from disk incase it changes\r\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\r\n      template = template.replace(\r\n        `src=\"/src/main.tsx\"`,\r\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\r\n      );\r\n      const page = await vite.transformIndexHtml(url, template);\r\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\r\n    } catch (e) {\r\n      vite.ssrFixStacktrace(e as Error);\r\n      next(e);\r\n    }\r\n  });\r\n}\r\n\r\nexport function serveStatic(app: Express) {\r\n  const distPath = path.resolve(import.meta.dirname, \"public\");\r\n\r\n  if (!fs.existsSync(distPath)) {\r\n    throw new Error(\r\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\r\n    );\r\n  }\r\n\r\n  app.use(express.static(distPath));\r\n\r\n  // fall through to index.html if the file doesn't exist\r\n  app.use(\"*\", (_req, res) => {\r\n    res.sendFile(path.resolve(distPath, \"index.html\"));\r\n  });\r\n}\r\n"]}